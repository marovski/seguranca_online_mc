// Add this method outside the class to make it globally accessible
function shareResult(platform) {
    // Get the game instance (assuming it's the most recently created instance)
    const gameInstances = window.securityGameInstances || [];
    const lastGameInstance = gameInstances[gameInstances.length - 1];
    
    if (lastGameInstance) {
        lastGameInstance.shareResult(platform);
    }
}

class SecurityGame {
    constructor() {
        this.currentLevel = 0;
        this.score = 0;
        this.levels = this.getLevels();

        // Track game instances globally
        window.securityGameInstances = window.securityGameInstances || [];
        window.securityGameInstances.push(this);

        this.initializeGame();
        this.updateVisitCounter();

        // Add event listeners for share buttons
        this.addShareButtonListeners();
    }

    getLevels() {
        return [
            {
                title: "Cria√ß√£o de Palavras-passe Fortes",
                type: "password",
                description: "Selecione a palavra-passe mais segura:",
                options: [
                    { text: "password123", correct: false },
                    { text: "MinhaDataNascimento1990", correct: false },
                    { text: "K9$mP#2@vL5nX", correct: true },
                    { text: "qwerty", correct: false }
                ],
                feedback: {
                    success: "Excelente! Uma palavra-passe forte combina letras mai√∫sculas e min√∫sculas, n√∫meros e s√≠mbolos.",
                    failure: "Esta palavra-passe n√£o √© suficientemente segura. Tente utilizar uma combina√ß√£o de caracteres diferentes."
                }
            },
            {
                title: "Autentica√ß√£o de Dois Fatores",
                type: "2fa",
                description: "Qual √© a melhor op√ß√£o para configurar 2FA?",
                options: [
                    { text: "Utilizar apenas palavra-passe", correct: false },
                    { text: "SMS + palavra-passe", correct: false },
                    { text: "Aplica√ß√£o autenticador + palavra-passe", correct: true },
                    { text: "Email de recupera√ß√£o", correct: false }
                ],
                feedback: {
                    success: "Correto! Uma aplica√ß√£o autenticador √© mais segura que SMS para 2FA.",
                    failure: "Esta n√£o √© a op√ß√£o mais segura para 2FA."
                }
            },
            {
                title: "Identifica√ß√£o de Phishing",
                type: "phishing",
                description: "Identifique o email suspeito:",
                options: [
                    { text: "suporte@bancodoportugal.pt - Atualiza√ß√£o de seguran√ßa necess√°ria", correct: false },
                    { text: "banco-portugal-urgente@mail.ru - O seu acesso foi bloqueado", correct: true },
                    { text: "newsletter@bancoportugal.pt - Relat√≥rio mensal", correct: false },
                    { text: "contacto@bancoportugal.pt - Confirma√ß√£o de transfer√™ncia", correct: false }
                ],
                feedback: {
                    success: "Correto! Emails de dom√≠nios suspeitos e mensagens urgentes s√£o sinais comuns de phishing.",
                    failure: "Preste aten√ß√£o ao dom√≠nio do email e ao tom urgente da mensagem."
                }
            },
            {
                title: "Atualiza√ß√µes de Dispositivos",
                type: "updates",
                description: "Qual √© a melhor pr√°tica para manter o seu dispositivo seguro?",
                options: [
                    { text: "Ignorar todas as atualiza√ß√µes", correct: false },
                    { text: "Atualizar apenas quando for conveniente", correct: false },
                    { text: "Ativar atualiza√ß√µes autom√°ticas", correct: true },
                    { text: "Atualizar apenas uma vez por ano", correct: false }
                ],
                feedback: {
                    success: "Correto! Manter o dispositivo atualizado ajuda a corrigir vulnerabilidades de seguran√ßa.",
                    failure: "As atualiza√ß√µes regulares s√£o cruciais para proteger o seu dispositivo contra novas amea√ßas."
                }
            },
            {
                title: "Seguran√ßa em WiFi P√∫blico",
                type: "wifi",
                description: "Como se proteger ao Utilizar WiFi p√∫blico?",
                options: [
                    { text: "Fazer login em todas as contas normalmente", correct: false },
                    { text: "Utilizar VPN e evitar transa√ß√µes sens√≠veis", correct: true },
                    { text: "Deixar o WiFi sempre ligado", correct: false },
                    { text: "Utilizar o mesmo WiFi sem cautela", correct: false }
                ],
                feedback: {
                    success: "Excelente! Uma VPN protege a sua conex√£o em redes p√∫blicas.",
                    failure: "Redes p√∫blicas podem ser inseguras. Tome precau√ß√µes adicionais ao navegar."
                }
            }
        ];
    }

    shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    initializeGame() {
        document.getElementById('start-btn').addEventListener('click', () => this.startGame());
        document.getElementById('continue-btn').addEventListener('click', () => this.hideModal());
        document.getElementById('restart-btn').addEventListener('click', () => this.restartGame());
    }

    addShareButtonListeners() {
        document.getElementById('share-twitter')?.addEventListener('click', () => this.shareResult('twitter'));
        document.getElementById('share-whatsapp')?.addEventListener('click', () => this.shareResult('whatsapp'));
        document.getElementById('copy-link')?.addEventListener('click', () => this.shareResult('copy'));
    }

    startGame() {
        this.levels = this.shuffleArray(this.levels);
        this.switchScreen('title-screen', 'game-screen');
        this.loadLevel();
    }

    switchScreen(from, to) {
        document.getElementById(from).classList.remove('active');
        document.getElementById(to).classList.add('active');
    }

    loadLevel() {
        if (this.currentLevel >= this.levels.length) {
            this.endGame();
            return;
        }

        const level = this.levels[this.currentLevel];
        const levelEmojis = {
            "password": "üîë",
            "2fa": "üì±",
            "phishing": "üìß",
            "updates": "üîÑ",
            "wifi": "üì∂"
        };

        document.getElementById('level-title').textContent = `${levelEmojis[level.type]} ${level.title}`;
        document.getElementById('progress').style.width = `${(this.currentLevel / this.levels.length) * 100}%`;

        // Shuffle the options for this level
        const shuffledOptions = this.shuffleArray([...level.options]);

        const gameArea = document.getElementById('game-area');
        gameArea.innerHTML = `
            <p>${level.description}</p>
            <div class="options">
                ${shuffledOptions.map(option => `
                    <button class="choice-btn" data-correct="${option.correct}">
                        ${option.text}
                    </button>
                `).join('')}
            </div>
        `;

        gameArea.querySelectorAll('.choice-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.handleAnswer(e));
        });
    }

    handleAnswer(e) {
        const correct = e.target.dataset.correct === 'true';
        const level = this.levels[this.currentLevel];

        if (correct) {
            this.score += 100;
            document.getElementById('score-value').textContent = this.score;
        }

        this.showFeedback(correct ? level.feedback.success : level.feedback.failure, correct);
    }

    showFeedback(message, correct) {
        const modal = document.getElementById('feedback-modal');
        const feedbackEmoji = document.getElementById('feedback-emoji');
        
        document.getElementById('feedback-title').textContent = correct ? "Correto! ‚úÖ" : "Incorreto ‚ùå";
        document.getElementById('feedback-text').textContent = message;
        feedbackEmoji.textContent = correct ? "üåü" : "üòî";
        modal.style.display = 'flex';
    }

    hideModal() {
        document.getElementById('feedback-modal').style.display = 'none';
        this.currentLevel++;
        this.loadLevel();
    }

    endGame() {
        document.getElementById('final-score').textContent = this.score;
        this.switchScreen('game-screen', 'end-screen');
    }

    restartGame() {
        this.levels = this.shuffleArray(this.levels);
        this.currentLevel = 0;
        this.score = 0;
        document.getElementById('score-value').textContent = this.score;
        this.switchScreen('end-screen', 'title-screen');
    }

    updateVisitCounter() {
        // Get current visit count from localStorage
        let visits = localStorage.getItem('gameVisits') || 0;
        visits = parseInt(visits) + 1;
        
        // Update localStorage
        localStorage.setItem('gameVisits', visits);
        
        // Update the counter in the UI
        document.getElementById('visit-counter').textContent = visits;
    }

    shareResult(platform) {
        const score = this.score;
        const shareText = `Completei a Aventura Seguran√ßa Online com ${score} pontos! Teste os seus conhecimentos de ciberseguran√ßa em https://marovski.github.io/seguranca_online_mc/`;
        const url = 'https://www.balai.cv/autores/mario-cardoso/dekodifika-tech-como-manter-se-seguro-online/';

        switch(platform) {
            case 'twitter':
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
                break;
            case 'whatsapp':
                window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
                break;
            case 'copy':
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Link copiado para a √°rea de transfer√™ncia!');
                });
                break;
        }
    }
}

window.addEventListener('load', () => {
    new SecurityGame();
});
